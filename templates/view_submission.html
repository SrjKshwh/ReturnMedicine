{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">Submission {{ submission.submission_uuid }}</h1>
            <div>
                {% if submission.status == 'Draft' %}
                <form method="POST" action="{{ url_for('finalize_submission', submission_uuid=submission.submission_uuid) }}" class="d-inline">
                    <button type="submit" class="btn btn-success">Finalize & Submit</button>
                </form>
                {% endif %}
                <a href="{{ url_for('download_manifest', submission_uuid=submission.submission_uuid) }}" class="btn btn-outline-primary ms-2">Download Manifest</a>
                <a href="{{ url_for('download_label', submission_uuid=submission.submission_uuid) }}" class="btn btn-outline-secondary ms-2">Download Label</a>
            </div>
        </div>
        <div class="alert alert-info">
            <h5>How to use this page:</h5>
            <p>This page shows detailed information for a specific return submission. View the submission summary including status, date, item count, and total estimated credit. The items table displays each item with its NDC, quantity, expiration date, classification reason, returnable status, and estimated credit. The status history shows all status changes with timestamps. If the submission is in Draft status, you can finalize it for processing. Download PDF manifests and shipping labels using the buttons at the top.</p>
        </div>

        <!-- Submission Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Submission Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Status:</strong>
                        <span class="badge ms-2
                            {% if submission.status == 'Draft' %}bg-secondary
                            {% elif submission.status == 'Submitted' %}bg-warning
                            {% elif submission.status == 'Received' %}bg-info
                            {% elif submission.status == 'Credited' %}bg-success
                            {% else %}bg-light text-dark{% endif %}">
                            {{ submission.status }}
                        </span>
                    </div>
                    <div class="col-md-3">
                        <strong>Date:</strong> {{ submission.submission_date.strftime('%Y-%m-%d') }}
                    </div>
                    <div class="col-md-3">
                        <strong>Items:</strong> {{ submission.items|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Total Credit:</strong> ${{ "%.2f"|format(total_credit) }}
                    </div>
                </div>
                {% if submission.tracking_number %}
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Tracking Number:</strong> {{ submission.tracking_number }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Items Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Return Items</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>NDC</th>
                                <th>Quantity</th>
                                <th>Expiration Date</th>
                                <th>Classification</th>
                                <th>Returnable Status</th>
                                <th>Estimated Credit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in submission.items %}
                            <tr>
                                <td>{{ item.ndc }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.expiration_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if item.reason %}
                                        <span class="badge bg-info">{{ item.reason.name }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge
                                        {% if item.returnable_status == 'Eligible' %}bg-success
                                        {% elif item.returnable_status == 'Ineligible' or 'Ineligible' in item.returnable_status %}bg-danger
                                        {% else %}bg-warning{% endif %}">
                                        {{ item.returnable_status }}
                                    </span>
                                </td>
                                <td>${{ "%.2f"|format(item.estimated_credit) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Status History -->
        {% if submission.status_history %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Status History</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date/Time</th>
                                <th>Status Change</th>
                                <th>Updated By</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for update in submission.status_history|sort(attribute='updated_at', reverse=True) %}
                            <tr>
                                <td>{{ update.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if update.old_status %}
                                        {{ update.old_status }} â†’ {{ update.new_status }}
                                    {% else %}
                                        Initial: {{ update.new_status }}
                                    {% endif %}
                                </td>
                                <td>{{ update.updated_by }}</td>
                                <td>{{ update.notes or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Simulation Controls (for demo purposes) -->
        {% if submission.status != 'Credited' %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Status Update Simulation (Demo)</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">For demonstration purposes, you can simulate status updates:</p>
                <div class="d-flex gap-2 flex-wrap">
                    {% if submission.status == 'Submitted' %}
                    <form method="POST" action="{{ url_for('simulate_status_update', submission_uuid=submission.submission_uuid, new_status='Received') }}" class="d-inline">
                        <button type="submit" class="btn btn-info btn-sm">Mark as Received</button>
                    </form>
                    {% endif %}
                    {% if submission.status in ['Submitted', 'Received'] %}
                    <form method="POST" action="{{ url_for('simulate_status_update', submission_uuid=submission.submission_uuid, new_status='Credited') }}" class="d-inline">
                        <button type="submit" class="btn btn-success btn-sm">Mark as Credited</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="mt-3">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
    </div>
</div>
{% endblock %}